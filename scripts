-- Tahap 6: Auto-Buy Egg (mutasi) + chat control
-- Signature: ReplicatedStorage.Remote.CharacterRE:FireServer("BuyEgg", uid)

-- ============== CONFIG =================
local ISLAND_PARENT_NAME = "Art"             -- island ada di Workspace.Art
local DESIRED_MUTATIONS = { Golden = true }  -- kriteria mutasi aktif
local CONVEYOR_LEVEL_OVERRIDE = nil          -- contoh: 8 (nil = auto-detect Conveyor%d+)

local BUY_COOLDOWN_SEC = 0.35                -- jeda antar buy
local RESCAN_INTERVAL_SEC = 1.5              -- jeda rescan belt
local MAX_BUYS_PER_MIN = 120                 -- guardrail anti-spam
local LAST_BOUGHT_TTL_SEC = 4                -- cegah spam UID yg sama
local ENABLE_LOG = true

-- ===== Auto-Collect (Pets) CONFIG =====
local COLLECT_SLEEP_PER_PET = 0.05   -- jeda antar fire biar aman
local COLLECT_MAX_PETS = nil         -- batasi jumlah (mis. 50). nil = semua

-- ======================================

local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local StarterGui = game:GetService("StarterGui")
local TextChatService = game:GetService("TextChatService")

local localPlayer = Players.LocalPlayer
local character = localPlayer.Character or localPlayer.CharacterAdded:Wait()
local root = character:WaitForChild("HumanoidRootPart")

local function sys(t)
	pcall(function() StarterGui:SetCore("ChatMakeSystemMessage",{Text="[AutoEgg] "..t}) end)
	if ENABLE_LOG then print("[AutoEgg]", t) end
end

-- ---------- Helpers: island / conveyor / belt ----------
local function findActiveIsland()
	local parent = Workspace:FindFirstChild(ISLAND_PARENT_NAME) or Workspace
	local best, bestDist = nil, math.huge
	for _, m in ipairs(parent:GetChildren()) do
		if m.Name:match("^Island_%d+$") then
			local p = m.PrimaryPart or m:FindFirstChildWhichIsA("BasePart", true)
			if p then
				local d = (p.Position - root.Position).Magnitude
				if d < bestDist then best, bestDist = m, d end
			end
		end
	end
	return best
end

local function findConveyor(island, levelOverride)
	if not island then return nil end
	if levelOverride then
		local target = "Conveyor"..tostring(levelOverride)
		for _, d in ipairs(island:GetDescendants()) do
			if d:IsA("Model") and d.Name == target then return d end
		end
	end
	-- auto: cari Conveyor%d+ yang punya Belt; ambil level terbesar
	local best, bestNum = nil, -1
	for _, d in ipairs(island:GetDescendants()) do
		if d:IsA("Model") then
			local n = d.Name:match("^Conveyor(%d+)$")
			if n and d:FindFirstChild("Belt") then
				n = tonumber(n)
				if n > bestNum then best, bestNum = d, n end
			end
		end
	end
	return best
end

-- ---------- Validasi egg & mutasi ----------
local function getIslandEggFolder(islandModel)
	local eggs = ReplicatedStorage:FindFirstChild("Eggs"); if not eggs then return nil end
	return eggs:FindFirstChild(islandModel.Name)
end

local function iterValidEggs(islandModel, belt)
	local folder = getIslandEggFolder(islandModel)
	if not folder then return function() return nil end end
	local list = {}
	for _, item in ipairs(belt:GetChildren()) do
		local uid = item.Name
		local data = folder:FindFirstChild(uid)
		if data then
			table.insert(list, {uid=uid, data=data, item=item})
		end
	end
	local i = 0
	return function() i += 1; return list[i] end
end

local function isMutationMatch(data)
	if not data then return false end
	local m = data:GetAttribute("M")
	return m and DESIRED_MUTATIONS[tostring(m)] == true
end

-- ---------- Remote pembelian ----------
local function getBuyRemote()
	local remoteFolder = ReplicatedStorage:WaitForChild("Remote", 5)
	if not remoteFolder then return nil end
	return remoteFolder:FindFirstChild("CharacterRE")
end

local function fireBuy(uid)
	local re = getBuyRemote()
	if not re or not re:IsA("RemoteEvent") then
		sys("❌ RemoteEvent ReplicatedStorage.Remote.CharacterRE tidak ditemukan.")
		return false
	end
	local ok, err = pcall(function()
		re:FireServer("BuyEgg", uid) -- SIGNATURE
	end)
	if ok then return true else sys("❌ FireServer gagal: "..tostring(err)); return false end
end

-- ========== ONE-SHOT AUTO COLLECT PETS ==========
local collecting = false

local function oneShotCollectPets()
	if collecting then
		sys("Collect lagi berjalan. Tunggu selesai ya.")
		return
	end
	collecting = true

	task.spawn(function()
		local ok, err = pcall(function()
			-- cari folder Pets
			local petsFolder = Workspace:WaitForChild("Pets")
			if not petsFolder then
				sys("❌ Folder Workspace.Pets tidak ditemukan.")
				return
			end

			local processed, success, total = 0, 0, #petsFolder:GetChildren()
			sys("Mulai collect ...")

			for _, pet in ipairs(petsFolder:GetChildren()) do
				if COLLECT_MAX_PETS and processed >= COLLECT_MAX_PETS then break end
				local rootPart = pet:FindFirstChild("RootPart")
				if rootPart then
					local remote = rootPart:FindFirstChild("RE")
					if remote and remote:IsA("RemoteEvent") then
						local okFire, errFire = pcall(function()
							remote:FireServer("Claim")
						end)
						processed += 1
						if okFire then success += 1 else
							if ENABLE_LOG then warn("[AutoEgg] Collect gagal:", errFire) end
						end
						if COLLECT_SLEEP_PER_PET and COLLECT_SLEEP_PER_PET > 0 then
							task.wait(COLLECT_SLEEP_PER_PET)
						end
					end
				end
			end

			sys("Collect selesai.")
		end)

		if not ok then
			sys("❌ Collect error: "..tostring(err))
		end
		collecting = false
	end)
end


-- ---------- Rate limit & anti double ----------
local buysWindow = {}
local lastBoughtAt = {} -- uid -> time

local function canBuyNow()
	local now = os.clock()
	for i = #buysWindow, 1, -1 do
		if now - buysWindow[i] > 60 then table.remove(buysWindow, i) end
	end
	return #buysWindow < MAX_BUYS_PER_MIN
end

local function recordBuy(uid)
	buysWindow[#buysWindow+1] = os.clock()
	lastBoughtAt[uid] = os.clock()
end

local function recentlyBought(uid)
	local t = lastBoughtAt[uid]
	return t and (os.clock() - t) < LAST_BOUGHT_TTL_SEC
end

-- ---------- Main loop ----------
local running = false
local mainLoop
function mainLoop()
	sys("Loop mulai.")
	while running do
		local island = findActiveIsland()
		if not island then
			sys("Island belum ketemu…")
			task.wait(RESCAN_INTERVAL_SEC)
			continue
		end

		local conveyor = findConveyor(island, CONVEYOR_LEVEL_OVERRIDE)
		local belt = conveyor and conveyor:FindFirstChild("Belt") or nil
		if not (conveyor and belt) then
			task.wait(RESCAN_INTERVAL_SEC)
			continue
		end

		for e in iterValidEggs(island, belt) do
			if not running then break end
			if isMutationMatch(e.data) then
				local uid = e.uid
				if not recentlyBought(uid) and canBuyNow() then
					if fireBuy(uid) then
						recordBuy(uid)
						if ENABLE_LOG then
							local m = e.data:GetAttribute("M")
							print(("[AutoEgg] BUY uid=%s M=%s"):format(uid, tostring(m)))
						end
						task.wait(BUY_COOLDOWN_SEC)
					end
				end
			end
		end

		task.wait(RESCAN_INTERVAL_SEC)
	end
	sys("Loop berhenti.")
end

-- ---------- Chat commands ----------
local PREFIX, BASE = "!", "buyegg"
local function listActiveMutations()
	local t = {}
	for k,v in pairs(DESIRED_MUTATIONS) do if v then t[#t+1]=k end end
	table.sort(t); return #t>0 and table.concat(t,", ") or "(kosong)"
end

local function tryParseCommand(msg)
	if not msg or msg:sub(1,#PREFIX) ~= PREFIX then return end
	local parts = string.split(msg:sub(#PREFIX+1), " ")
	if #parts==0 then return end
	parts[1] = parts[1]:lower()
	if parts[1] ~= BASE then return end

	local sub = (parts[2] or "help"):lower()

	if sub == "start" then
		if running then sys("Sudah berjalan.") else running = true; task.spawn(mainLoop); sys("Dimulai.") end

	elseif sub == "collect" then
		oneShotCollectPets()

	elseif sub == "stop" then
		if running then running = false; sys("Dihentikan.") else sys("Sudah berhenti.") end

	elseif sub == "status" then
		sys(("Status: %s | Mutasi aktif: %s | Level: %s | Window buys: %d/min")
			:format(running and "BERJALAN" or "BERHENTI",
				listActiveMutations(),
				CONVEYOR_LEVEL_OVERRIDE and tostring(CONVEYOR_LEVEL_OVERRIDE) or "auto",
				#buysWindow))

	elseif sub == "eggs" then
		local island = findActiveIsland(); if not island then sys("Island?"); return end
		local conveyor = findConveyor(island, CONVEYOR_LEVEL_OVERRIDE); if not conveyor then sys("Conveyor?"); return end
		local belt = conveyor:FindFirstChild("Belt"); if not belt then sys("Belt?"); return end
		local shown, folder = 0, getIslandEggFolder(island)
		for e in iterValidEggs(island, belt) do
			local m = e.data:GetAttribute("M")
			sys(("[%02d] uid=%s | M=%s | match=%s"):format(shown+1, e.uid, tostring(m), tostring(isMutationMatch(e.data))))
			shown += 1; if shown >= 15 then break end
		end
		if shown == 0 then sys("Tidak ada egg valid terdeteksi di Belt.") end

	elseif sub == "setlevel" then
		local p = parts[3]
		if p == nil or p == "auto" then
			CONVEYOR_LEVEL_OVERRIDE = nil
			sys("Conveyor level: AUTO")
		else
			local n = tonumber(p)
			if n then
				CONVEYOR_LEVEL_OVERRIDE = n
				sys("Conveyor level di-set ke: "..n)
			else
				sys("Pakai: !buyegg setlevel <n|auto>")
			end
		end

	elseif sub == "setmut" then
		local name = parts[3]; local onoff = parts[4] and parts[4]:lower()
		if not name or (onoff ~= "on" and onoff ~= "off") then
			sys("Pakai: !buyegg setmut <Nama> on|off (contoh: !buyegg setmut Golden on)")
			return
		end
		DESIRED_MUTATIONS[name] = (onoff == "on")
		sys("Mutasi aktif sekarang: "..listActiveMutations())

	elseif sub == "test" then
		local island = findActiveIsland(); if not island then sys("Island?"); return end
		local conveyor = findConveyor(island, CONVEYOR_LEVEL_OVERRIDE); if not conveyor then sys("Conveyor?"); return end
		local belt = conveyor:FindFirstChild("Belt"); if not belt then sys("Belt?"); return end
		for e in iterValidEggs(island, belt) do
			if isMutationMatch(e.data) then
				sys("Test beli uid="..e.uid)
				fireBuy(e.uid); return
			end
		end
		sys("Tidak ada egg yang match mutasi aktif.")

	elseif sub == "buy" then
		local uid = parts[3]
		if not uid then sys("Pakai: !buyegg buy <uid>"); return end
		fireBuy(uid)

	else
		sys("Perintah: !buyegg start | stop | status | eggs | setmut <Nama> on|off | setlevel <n|auto> | test | buy <uid>")
	end
end

if TextChatService and TextChatService.ChatVersion == Enum.ChatVersion.TextChatService then
	if TextChatService.SendingMessage then
		TextChatService.SendingMessage:Connect(function(props)
			if props and props.Text and props.Text:sub(1,#PREFIX)==PREFIX then
				tryParseCommand(props.Text); props.Text=""
			end
		end)
	end
else
	localPlayer.Chatted:Connect(tryParseCommand)
end

sys("Auto-Buy siap. Gunakan: !buyegg start / stop / status / collect  | setmut Golden on|off | setlevel <n|auto>")
